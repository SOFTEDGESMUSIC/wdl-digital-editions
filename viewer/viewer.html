<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>WDL Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<link rel="stylesheet" href="viewer.css"/>
<script src="https://softedgesmusic.github.io/wdl-digital-editions/lib/pdfjs/pdf.min.js"></script>
<script src="https://softedgesmusic.github.io/wdl-digital-editions/lib/pdfjs/pdf.worker.min.js"></script>
</head>
<body>
<div id="progress"></div>
<div id="viewer"></div>
<div id="thumbstrip"></div>
<div id="controls">
  <button id="prev">⟨</button>
  <span id="page-info">1 / ?</span>
  <button id="next">⟩</button>
  <button id="zoom-out">−</button>
  <button id="zoom-in">+</button>
  <button id="zoom-fit">⤢</button>
  <button id="fullscreen">[ ]</button>
  <button id="toggle-thumbs">🖼️</button>
  <a id="openpdf" target="_blank">📄</a>
</div>

<script>
const url = new URLSearchParams(location.search).get("pdf") || 
  "/editions/WDL210825Merged.pdf";

const viewer = document.getElementById("viewer");
const pageInfo = document.getElementById("page-info");
const progress = document.getElementById("progress");
const thumbstrip = document.getElementById("thumbstrip");
const openpdf = document.getElementById("openpdf");

openpdf.href = url;

let pdfDoc=null, current=1, total=0, zoom=1.0;
let canvas=document.createElement("canvas"), ctx=canvas.getContext("2d");
viewer.appendChild(canvas);

function setProgress(p){
  progress.style.width=(p*100)+"%";
}

// Render page
async function renderPage(num){
  const page=await pdfDoc.getPage(num);
  const vw=viewer.clientWidth, vh=viewer.clientHeight-80;
  const scale=Math.min(vw/page.getViewport({scale:1}).width,
                       vh/page.getViewport({scale:1}).height)*zoom;
  const viewport=page.getViewport({scale});
  canvas.width=viewport.width; canvas.height=viewport.height;
  viewer.scrollLeft=0; viewer.scrollTop=0;
  await page.render({canvasContext:ctx,viewport}).promise;
  pageInfo.textContent=`${num} / ${total}`;
  setProgress(1);
  highlightThumb(num);
}

// Highlight current thumbnail
function highlightThumb(num){
  [...thumbstrip.querySelectorAll("canvas")].forEach((c,i)=>{
    c.classList.toggle("active", i+1===num);
  });
}

// Build thumbnails
async function buildThumbs(){
  for(let i=1;i<=total;i++){
    const page=await pdfDoc.getPage(i);
    const vp=page.getViewport({scale:0.15});
    const c=document.createElement("canvas");
    c.width=vp.width; c.height=vp.height;
    await page.render({canvasContext:c.getContext("2d"),viewport:vp}).promise;
    c.onclick=()=>{current=i; renderPage(current);};
    thumbstrip.appendChild(c);
  }
}

// Load PDF
pdfjsLib.getDocument(url).promise.then(doc=>{
  pdfDoc=doc; total=doc.numPages;
  buildThumbs();
  renderPage(current);
});

// Controls
document.getElementById("prev").onclick=()=>{if(current>1){current--;renderPage(current);}};
document.getElementById("next").onclick=()=>{if(current<total){current++;renderPage(current);}};
document.getElementById("zoom-in").onclick=()=>{zoom*=1.2;renderPage(current);};
document.getElementById("zoom-out").onclick=()=>{zoom/=1.2;renderPage(current);};
document.getElementById("zoom-fit").onclick=()=>{zoom=1.0;renderPage(current);};
document.getElementById("fullscreen").onclick=()=>{
  if(document.fullscreenElement){document.exitFullscreen();}
  else{document.documentElement.requestFullscreen();}
};

// Toggle thumbnails on mobile
document.getElementById("toggle-thumbs").onclick = () => {
  thumbstrip.classList.toggle("show");
};

// Double-tap zoom for mobile
let lastTap=0;
viewer.addEventListener("touchend",e=>{
  const now=Date.now();
  if(now-lastTap<300 && e.changedTouches.length===1){
    if(Math.abs(zoom-1.0)<0.05){zoom=2.0;}else{zoom=1.0;}
    renderPage(current);
  }
  lastTap=now;
});

// Wheel zoom (desktop)
viewer.addEventListener("wheel",e=>{
  if(e.ctrlKey){
    e.preventDefault();
    zoom*=e.deltaY<0?1.1:0.9;
    renderPage(current);
  }
});
</script>
</body>
</html>
