<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>WDL Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no"/>
<link rel="stylesheet" href="viewer.css"/>
<script src="https://softedgesmusic.github.io/wdl-digital-editions/lib/pdfjs/pdf.min.js"></script>
<script src="https://softedgesmusic.github.io/wdl-digital-editions/lib/pdfjs/pdf.worker.min.js"></script>
</head>
<body>
<div id="progress"></div>
<div id="viewer"></div>
<div id="controls">
  <button id="prev">âŸ¨</button>
  <span id="page-info">1 / ?</span>
  <button id="next">âŸ©</button>
  <button id="zoom-out">âˆ’</button>
  <button id="zoom-in">+</button>
  <button id="zoom-fit">â¤¢</button>
  <button id="fullscreen">[ ]</button>
  <a id="openpdf" target="_blank">ğŸ“„</a>
</div>

<script>
const url = new URLSearchParams(location.search).get("pdf") ||
  "/editions/WDL210825Merged.pdf";

const viewer = document.getElementById("viewer");
const pageInfo = document.getElementById("page-info");
const progress = document.getElementById("progress");
const openpdf = document.getElementById("openpdf");
openpdf.href = url;

let pdfDoc=null, current=1, total=0, zoom=1.0;
let canvas=document.createElement("canvas"), ctx=canvas.getContext("2d");
viewer.appendChild(canvas);

// Progress bar
function setProgress(p){
  progress.style.width=(p*100)+"%";
}

// Render page
async function renderPage(num){
  const page=await pdfDoc.getPage(num);
  const toolbarH = document.getElementById("controls").offsetHeight || 50;
  const vw = viewer.clientWidth;
  const vh = viewer.clientHeight - toolbarH - 10;
  const baseVp = page.getViewport({scale:1});
  const scale = Math.min(vw/baseVp.width, vh/baseVp.height) * zoom;
  const viewport = page.getViewport({scale});
  canvas.width=viewport.width;
  canvas.height=viewport.height;
  await page.render({canvasContext:ctx,viewport}).promise;
  pageInfo.textContent=`${num} / ${total}`;
  setProgress(1);
}

// Load PDF
pdfjsLib.getDocument(url).promise.then(doc=>{
  pdfDoc=doc; total=doc.numPages;
  renderPage(current);
}).catch(err=>{
  console.error("PDF load error",err);
  progress.textContent="Failed to load PDF.";
});

// Controls
document.getElementById("prev").onclick=()=>{
  if(current>1){current--;renderPage(current);}
};
document.getElementById("next").onclick=()=>{
  if(current<total){current++;renderPage(current);}
};
document.getElementById("zoom-in").onclick=()=>{
  zoom*=1.2; renderPage(current);
};
document.getElementById("zoom-out").onclick=()=>{
  zoom/=1.2; renderPage(current);
};
document.getElementById("zoom-fit").onclick=()=>{
  zoom=1.0; renderPage(current);
};
document.getElementById("fullscreen").onclick=()=>{
  if(document.fullscreenElement){document.exitFullscreen();}
  else{document.documentElement.requestFullscreen();}
};

// Double-tap zoom (mobile)
let lastTap=0;
viewer.addEventListener("touchend",e=>{
  const now=Date.now();
  if(now-lastTap<300 && e.changedTouches.length===1){
    if(Math.abs(zoom-1.0)<0.05){zoom=2.0;}else{zoom=1.0;}
    renderPage(current);
  }
  lastTap=now;
});

// Ctrl+wheel zoom (desktop)
viewer.addEventListener("wheel",e=>{
  if(e.ctrlKey){
    e.preventDefault();
    zoom*=e.deltaY<0?1.1:0.9;
    renderPage(current);
  }
});

// Keep page centered when resizing window
window.addEventListener("resize",()=>{
  renderPage(current);
});
</script>
</body>
</html>
