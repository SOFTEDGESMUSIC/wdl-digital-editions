<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>WDL PDF Viewer</title>
  <style>
    html, body {
      margin:0; padding:0;
      height:100%; width:100%;
      background:#fff; overflow:hidden;
      font-family: sans-serif;
    }
    #viewer {
      position:absolute; top:0; left:0; right:0; bottom:40px;
      display:flex; justify-content:center; align-items:center;
      overflow:auto;
      background:#fff;
    }
    #scaleWrap {
      transform-origin: center center;
      transition: transform 0.25s;
    }
    canvas { display:block; margin:auto; }

    /* Control bar */
    #toolbar {
      position:absolute; bottom:0; left:50%;
      transform:translateX(-50%);
      background:#fff; color:#000;
      display:flex; gap:10px; align-items:center;
      padding:6px 12px;
      border-radius:4px;
      width:33%;
      justify-content:center;
    }
    #toolbar button {
      background:none; border:none;
      font-size:16px; cursor:pointer;
    }
    #toolbar .spacer { flex:1; }

    /* Thumbnails */
    #thumbs {
      position:absolute; top:0; left:0; right:0;
      display:flex; gap:4px; overflow-x:auto;
      padding:4px; background:#fff;
      border-bottom:1px solid #ddd;
      height:90px; box-sizing:border-box;
    }
    #thumbs canvas { height:80px; cursor:pointer; }

    /* Loading overlay */
    #loadingOverlay {
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      background:rgba(255,255,255,.9);
      font-size:1.2rem; color:#333;
      z-index:99;
    }
  </style>
</head>
<body>
  <div id="thumbs"></div>
  <div id="viewer"><div id="scaleWrap"><canvas id="pageCv"></canvas></div></div>
  <div id="toolbar">
    <button id="prev">⟨</button>
    <span id="pageNum">1</span>/<span id="pageCount">?</span>
    <button id="next">⟩</button>
    <div class="spacer"></div>
    <button id="zoomOut">−</button>
    <button id="zoomIn">＋</button>
    <button id="fit">⤢</button>
    <a id="download" href="#" download title="Download PDF">⬇</a>
  </div>
  <div id="loadingOverlay">Loading PDF…</div>

<script>
const pdfUrl = new URLSearchParams(location.search).get("pdf") 
  || "/editions/WDL210825Merged.pdf";

const PDFJS_CORE   = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.min.js";
const PDFJS_WORKER = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/4.2.67/pdf.worker.min.js";

let pdfDoc, current=1, total=0;
let zoom=1.0;
const viewer = document.getElementById('viewer');
const scaleWrap = document.getElementById('scaleWrap');
const pageCv = document.getElementById('pageCv');
const ctx = pageCv.getContext('2d');
const pageNum = document.getElementById('pageNum');
const pageCount = document.getElementById('pageCount');
const thumbs = document.getElementById('thumbs');
const overlay = document.getElementById('loadingOverlay');

// utility loader
function load(tag, attrs){
  return new Promise((res,rej)=>{
    const el=document.createElement(tag);
    Object.keys(attrs).forEach(k=>{
      if(attrs[k]!==undefined) {el[k]=attrs[k]; el.setAttribute(k,attrs[k]);}
    });
    el.onload=res; el.onerror=()=>rej(new Error("Load failed "+attrs.src));
    document.head.appendChild(el);
  });
}

// Zoom + centering
function applyZoom(){
  scaleWrap.style.transform = `scale(${zoom})`;
  const vp = viewer;
  const contentW = scaleWrap.getBoundingClientRect().width;
  const contentH = scaleWrap.getBoundingClientRect().height;
  vp.scrollLeft = Math.max(0,(contentW - vp.clientWidth)/2);
  vp.scrollTop  = Math.max(0,(contentH - vp.clientHeight)/2);
}

// Render page
async function renderPageToCanvas(num, canvas, maxHeight, scaleFactor){
  const page = await pdfDoc.getPage(num);
  const vport = page.getViewport({scale:1});
  const scale = (maxHeight/vport.height)*scaleFactor;
  const viewport = page.getViewport({scale});
  canvas.width=viewport.width;
  canvas.height=viewport.height;
  await page.render({canvasContext:canvas.getContext('2d'), viewport}).promise;
}

// Render main + thumbs
async function renderCurrent(){
  overlay.style.display="flex";
  await renderPageToCanvas(current,pageCv,viewer.clientHeight-100,1.0);
  overlay.style.display="none";
  fitToHeight();
  pageNum.textContent=current;
}
async function renderThumbs(){
  thumbs.innerHTML="";
  for(let i=1;i<=total;i++){
    const c=document.createElement("canvas");
    thumbs.appendChild(c);
    renderPageToCanvas(i,c,80,0.2);
    c.onclick=()=>{current=i;renderCurrent();}
  }
}

// Fit to height
function fitToHeight(){
  zoom=(viewer.clientHeight-100)/pageCv.height;
  applyZoom();
}

// Boot
(async function(){
  overlay.textContent="Loading PDF.js…";
  await load("script",{src:PDFJS_CORE});
  if(window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions){
    window.pdfjsLib.GlobalWorkerOptions.workerSrc=PDFJS_WORKER;
  }
  overlay.textContent="Parsing document…";
  pdfDoc=await window.pdfjsLib.getDocument({url:pdfUrl}).promise;
  total=pdfDoc.numPages;
  pageCount.textContent=total;
  document.getElementById('download').href=pdfUrl;
  await renderCurrent();
  renderThumbs();
})();

// Toolbar actions
document.getElementById('prev').onclick=()=>{if(current>1){current--;renderCurrent();}};
document.getElementById('next').onclick=()=>{if(current<total){current++;renderCurrent();}};
document.getElementById('zoomIn').onclick=()=>{zoom*=1.2;applyZoom();};
document.getElementById('zoomOut').onclick=()=>{zoom/=1.2;applyZoom();};
document.getElementById('fit').onclick=()=>{fitToHeight();};
</script>
</body>
</html>
