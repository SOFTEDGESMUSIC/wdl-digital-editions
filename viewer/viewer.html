<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>WDL Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="viewer.css"/>

<!-- PDF.js (self-hosted) -->
<script src="/wdl-digital-editions/lib/pdfjs/pdf.min.js"></script>
<script src="/wdl-digital-editions/lib/pdfjs/pdf.worker.min.js"></script>

<style>
  body {
    margin: 0;
    background: #fff;
    font-family: sans-serif;
  }

  #viewer {
    width: 100%;
    height: calc(100vh - 50px); /* leaves space for toolbar */
    overflow: auto;
    background: #fff;
  }

  #pageWrap {
    margin: 0 auto;
    display: block;
    background: #fff;
  }

  canvas {
    display: block;
    margin: 0 auto;
  }

  #progress {
    height: 4px;
    background: #4caf50;
    width: 0%;
    transition: width 0.3s;
  }

  #controls {
    height: 50px;
    display: flex;
    justify-content: center;
    align-items: center;
    background: #fff;
    border-top: 1px solid #ccc;
    gap: .5rem;
  }

  #controls button, #controls a {
    border: none;
    background: none;
    font-size: 1.2rem;
    cursor: pointer;
    padding: 0 .5rem;
    text-decoration: none;
    color: black;
  }

  #controls a {
    font-size: 1.4rem;
  }

  .edge {
    position: absolute;
    top: 0;
    bottom: 0;
    width: 20%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    color: rgba(0,0,0,0.2);
    font-size: 3rem;
    user-select: none;
  }
  .edge-left { left: 0; }
  .edge-right { right: 0; }
  .edge:hover { color: rgba(0,0,0,0.5); }
</style>
</head>
<body>
<div id="progress"></div>

<div id="viewer">
  <div id="pageWrap">
    <canvas id="pageCanvas"></canvas>
    <div class="edge edge-left"  id="edgePrev" aria-label="Previous page"><span class="chev">‹</span></div>
    <div class="edge edge-right" id="edgeNext" aria-label="Next page"><span class="chev">›</span></div>
  </div>
</div>

<div id="controls" role="toolbar" aria-label="Document controls">
  <button id="prev" title="Previous page">⟨</button>
  <span id="page-info">1 / ?</span>
  <button id="next" title="Next page">⟩</button>

  <button id="zoom-out" title="Zoom out">−</button>
  <button id="zoom-in"  title="Zoom in">+</button>
  <button id="zoom-fit" title="Fit to window">⤢</button>

  <!-- Fullscreen icon (four corners) -->
  <button id="fullscreen" title="Fullscreen" style="padding:0 .4rem">
    <svg width="18" height="18" viewBox="0 0 24 24">
      <path d="M4 9V4h5M20 9V4h-5M4 15v5h5M20 15v5h-5"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="square"/>
    </svg>
  </button>

  <!-- Open in new tab (down arrow) -->
  <a id="openpdf" target="_blank" rel="noopener" title="Open PDF in new tab">⬇</a>
</div>

<script>
(function(){
  const DEFAULT_PDF = "/wdl-digital-editions/editions/WDL210825Merged.pdf";
  const params = new URLSearchParams(location.search);
  const pdfURL = params.get("pdf") || params.get("file") || DEFAULT_PDF;

  const viewer   = document.getElementById("viewer");
  const wrap     = document.getElementById("pageWrap");
  const canvas   = document.getElementById("pageCanvas");
  const ctx      = canvas.getContext("2d");
  const progress = document.getElementById("progress");
  const pageInfo = document.getElementById("page-info");
  const edgePrev = document.getElementById("edgePrev");
  const edgeNext = document.getElementById("edgeNext");
  const openpdf  = document.getElementById("openpdf");
  openpdf.href   = pdfURL;

  let pdfDoc=null, current=1, total=0, zoom=1;
  const DPR = Math.max(1, window.devicePixelRatio||1);

  function setProgress(p){
    progress.style.width = (p*100) + '%';
  }

  async function renderPage(num){
    const page = await pdfDoc.getPage(num);

    const vw = viewer.clientWidth, vh = viewer.clientHeight;
    const vp1 = page.getViewport({scale:1});

    const fit = Math.min(vw/vp1.width, vh/vp1.height);
    zoom = fit;

    const vp = page.getViewport({scale:fit});
    const cssW = Math.floor(vp.width), cssH = Math.floor(vp.height);

    canvas.width  = Math.floor(cssW * DPR);
    canvas.height = Math.floor(cssH * DPR);
    canvas.style.width  = cssW+"px";
    canvas.style.height = cssH+"px";
    wrap.style.width    = cssW+"px";
    wrap.style.height   = cssH+"px";

    setProgress(0.1);
    await page.render({
      canvasContext: ctx,
      transform: DPR!==1 ? [DPR,0,0,DPR,0,0] : null,
      viewport: vp
    }).promise;
    setProgress(1);

    viewer.scrollLeft = 0;
    viewer.scrollTop = 0; // always start from top
    pageInfo.textContent = `${num} / ${total}`;
  }

  async function loadPDF(url){
    pdfjsLib.GlobalWorkerOptions.workerSrc = "/wdl-digital-editions/lib/pdfjs/pdf.worker.min.js";
    const doc = await pdfjsLib.getDocument({ url }).promise;
    return doc;
  }

  async function goTo(n){
    current = Math.max(1, Math.min(total, n));
    await renderPage(current);
  }

  // Controls
  document.getElementById("prev").onclick = ()=>goTo(current-1);
  document.getElementById("next").onclick = ()=>goTo(current+1);
  document.getElementById("zoom-in").onclick  = ()=>{zoom*=1.2;renderPage(current);};
  document.getElementById("zoom-out").onclick = ()=>{zoom/=1.2;renderPage(current);};
  document.getElementById("zoom-fit").onclick = ()=>{zoom=1;renderPage(current);};
  document.getElementById("fullscreen").onclick=()=>{
    const el = viewer;
    const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen || el.mozRequestFullScreen;
    if (req) req.call(el); else window.open(pdfURL,'_blank','noopener');
  };

  // Keyboard
  window.addEventListener('keydown',(e)=>{
    if (e.key==="ArrowLeft") goTo(current-1);
    if (e.key==="ArrowRight") goTo(current+1);
  });

  // Edge clicks
  edgePrev.onclick=()=>goTo(current-1);
  edgeNext.onclick=()=>goTo(current+1);

  // Init
  loadPDF(pdfURL).then(doc=>{
    pdfDoc=doc; total=doc.numPages;
    renderPage(current);
  }).catch(e=>console.error("PDF load error",e));
})();
</script>
</body>
</html>
