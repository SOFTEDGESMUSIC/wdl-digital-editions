<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<title>WDL Viewer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<link rel="stylesheet" href="viewer.css"/>

<!-- PDF.js (self-hosted) -->
<script src="/wdl-digital-editions/lib/pdfjs/pdf.min.js"></script>
<script src="/wdl-digital-editions/lib/pdfjs/pdf.worker.min.js"></script>
</head>
<body>
<div id="progress"></div>

<div id="viewer">
  <div id="pageWrap">
    <canvas id="pageCanvas"></canvas>
    <div class="edge edge-left"  id="edgePrev"  aria-label="Previous page"><span class="chev">‹</span></div>
    <div class="edge edge-right" id="edgeNext"  aria-label="Next page"><span class="chev">›</span></div>
  </div>
</div>

<div id="controls" role="toolbar" aria-label="Document controls">
  <button id="prev" title="Previous page" aria-label="Previous page">⟨</button>
  <span id="page-info" aria-live="polite">1 / ?</span>
  <button id="next" title="Next page" aria-label="Next page">⟩</button>

  <!-- Toggle Fit (Page <-> Width) -->
  <button id="zoom-toggle" title="Toggle Fit (Page/Width)" aria-label="Toggle Fit">⤢</button>

  <!-- Fullscreen icon (four corners) -->
  <button id="fullscreen" title="Fullscreen" aria-label="Fullscreen" style="padding:0 .4rem">
    <svg width="18" height="18" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M4 9V4h5M20 9V4h-5M4 15v5h5M20 15v5h-5"
            fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="square"/>
    </svg>
  </button>

  <!-- Open in new tab (down arrow) -->
  <a id="openpdf" title="Open PDF in new tab" target="_blank" rel="noopener" aria-label="Open PDF">⬇</a>
</div>

<script>
(function(){
  // ---------- CONFIG ----------
  const DEFAULT_PDF = "/wdl-digital-editions/editions/latest.pdf";
  const params = new URLSearchParams(location.search);
  const pdfURL = params.get("pdf") || params.get("file") || DEFAULT_PDF;

  // ---------- ELEMENTS ----------
  const viewer   = document.getElementById("viewer");
  const wrap     = document.getElementById("pageWrap");
  const canvas   = document.getElementById("pageCanvas");
  const ctx      = canvas.getContext("2d");
  const progress = document.getElementById("progress");
  const pageInfo = document.getElementById("page-info");
  const openpdf  = document.getElementById("openpdf");
  const btnToggle= document.getElementById("zoom-toggle");
  const edgePrev = document.getElementById("edgePrev");
  const edgeNext = document.getElementById("edgeNext");

  openpdf.href   = pdfURL;

  // ---------- STATE ----------
  let pdfDoc=null, current=1, total=0;
  let fitMode = "page";              // "page" or "width"
  const DPR = Math.max(1, window.devicePixelRatio||1);

  // ---------- UTILS ----------
  function setProgress(p){
    if (p>0 && p<1) progress.classList.add('active'); else progress.classList.remove('active');
    progress.style.width = (p*100) + '%';
  }
  const clamp=(n,a,b)=>Math.max(a,Math.min(b,n));

  function box(){ return { vw: viewer.clientWidth, vh: viewer.clientHeight }; }

  function computeScales(page){
    const vp1 = page.getViewport({scale:1});
    const {vw, vh} = box();
    return { fitPage: Math.min(vw / vp1.width, vh / vp1.height), fitWidth: vw / vp1.width };
  }

  function anchorFromCenter(){
    return {
      rx: (viewer.scrollLeft + viewer.clientWidth/2) / Math.max(1, wrap.clientWidth),
      ry: (viewer.scrollTop  + viewer.clientHeight/2) / Math.max(1, wrap.clientHeight),
    };
  }

  async function renderPage(num, opts={}){
    const page = await pdfDoc.getPage(num);
    const { fitPage, fitWidth } = computeScales(page);
    const scale = (fitMode === "page") ? fitPage : fitWidth;

    const vp   = page.getViewport({scale});
    const cssW = Math.floor(vp.width);
    const cssH = Math.floor(vp.height);

    let rx = 0.5, ry = 0;
    if (opts.anchor && typeof opts.anchor.rx === 'number') rx = opts.anchor.rx;
    if (opts.anchor && typeof opts.anchor.ry === 'number') ry = opts.anchor.ry;

    canvas.style.width  = cssW + "px";
    canvas.style.height = cssH + "px";
    wrap.style.width    = cssW + "px";
    wrap.style.height   = cssH + "px";

    canvas.width  = Math.floor(cssW * DPR);
    canvas.height = Math.floor(cssH * DPR);

    setProgress(0.12);
    await page.render({
      canvasContext: ctx,
      transform: DPR!==1 ? [DPR,0,0,DPR,0,0] : null,
      viewport: vp
    }).promise;
    setProgress(1);

    const newW = wrap.clientWidth, newH = wrap.clientHeight;
    const left = clamp(rx * newW - viewer.clientWidth/2, 0, Math.max(0, newW - viewer.clientWidth));
    const top  = clamp(ry * newH - viewer.clientHeight/2, 0, Math.max(0, newH - viewer.clientHeight));
    viewer.scrollLeft = left;
    viewer.scrollTop  = (opts.keepTop ? 0 : top);

    pageInfo.textContent = `${num} / ${total}`;
  }

  async function loadPDF(url){
    pdfjsLib.GlobalWorkerOptions.workerSrc = "/wdl-digital-editions/lib/pdfjs/pdf.worker.min.js";
    const task = pdfjsLib.getDocument({ url });
    task.onProgress = (e)=>{ if (e && e.total) setProgress(Math.min(0.9, e.loaded/e.total)); };
    const doc = await task.promise;
    setProgress(0.98);
    return doc;
  }

  async function goTo(n){
    current = clamp(n, 1, total);
    await renderPage(current, { keepTop:true });
  }

  // ---------- Controls ----------
  document.getElementById("prev").onclick = ()=>goTo(current-1);
  document.getElementById("next").onclick = ()=>goTo(current+1);

  // Toggle Fit (button)
  btnToggle.onclick = ()=>{
    const anchor = anchorFromCenter();
    fitMode = (fitMode === "page") ? "width" : "page";
    renderPage(current, { anchor });
  };

  // Double-click to toggle fit (desktop)
  viewer.addEventListener('dblclick', (e)=>{
    const rect = viewer.getBoundingClientRect();
    const anchor = {
      rx: (viewer.scrollLeft + (e.clientX-rect.left)) / Math.max(1, wrap.clientWidth),
      ry: (viewer.scrollTop  + (e.clientY-rect.top )) / Math.max(1, wrap.clientHeight),
    };
    fitMode = (fitMode === "page") ? "width" : "page";
    renderPage(current, { anchor });
  }, {passive:false});

  // Double-tap to toggle fit (mobile)
  let lastTap=0;
  viewer.addEventListener('touchend', (e)=>{
    const now = Date.now();
    if (e.changedTouches.length===1 && now-lastTap<300){
      const rect = viewer.getBoundingClientRect();
      const t = e.changedTouches[0];
      const anchor = {
        rx: (viewer.scrollLeft + (t.clientX-rect.left)) / Math.max(1, wrap.clientWidth),
        ry: (viewer.scrollTop  + (t.clientY-rect.top )) / Math.max(1, wrap.clientHeight),
      };
      fitMode = (fitMode === "page") ? "width" : "page";
      renderPage(current, { anchor });
    }
    lastTap = now;
  }, {passive:true});

  // Fullscreen (fallback opens PDF)
  document.getElementById("fullscreen").onclick=()=>{
    const el = viewer;
    const req = el.requestFullscreen || el.webkitRequestFullscreen || el.msRequestFullscreen || el.mozRequestFullScreen;
    if (req) req.call(el); else window.open(pdfURL,'_blank','noopener');
  };

  // Keyboard arrows
  window.addEventListener('keydown',(e)=>{
    if (e.target && /input|textarea|select/i.test(e.target.tagName)) return;
    if (e.key==="ArrowLeft")  { e.preventDefault(); goTo(current-1); }
    if (e.key==="ArrowRight") { e.preventDefault(); goTo(current+1); }
  });

  // Edge clicks
  edgePrev.onclick=()=>goTo(current-1);
  edgeNext.onclick=()=>goTo(current+1);

  // Resize keeps current fit mode
  window.addEventListener('resize', ()=>{
    renderPage(current, { anchor: anchorFromCenter() });
  });

  // Init
  loadPDF(pdfURL).then(doc=>{
    pdfDoc=doc; total=doc.numPages;
    renderPage(current, { keepTop:true });
  }).catch(e=>console.error("PDF load error", e));
})();
</script>
</body>
</html>
